# setup -------------------------------------------------------------------

library(tidyverse)
library(gamlss)
library(tidybayes)
library(brms)
library(bayesplot)

Sys.setlocale("LC_ALL","English")

# load data ----

df.ov_params = read.csv("data/calculated_parameters/df_ov_params.csv")

df.ov_params = df.ov_params %>% 
  select(year, campaign, date, species, sample_id, p50_spline, p12_spline, p88_spline, vessel_order) %>% 
  filter(vessel_order == "major") %>% 
  mutate(species = as.factor(species),
         sample_id = as.factor(sample_id),
         campaign = as.factor(campaign),
         year = as.factor(year),
         doy = yday(as.Date(date, format = "%d.%m.%Y")),
         date = as.Date(date, format = "%d.%m.%Y") %>% as.factor()) %>% 
  rename("p12_MPa" = "p12_spline",
         "p50_MPa" = "p50_spline",
         "p88_MPa" = "p88_spline")

# distribution selection ----
## https://www.gamlss.com/wp-content/uploads/2023/06/DistributionsForModellingLocationScaleandShape-1.pdf
## most are sufficiently far from 0 so probably not too special of a case here

## SHASH (Sinh-Arcsinh) is consistently best, NO (normal) is however much easier to comprehend

## P12 ---- 
m1.p12 = gamlss(p12_MPa ~ species * doy * year + re(random=~1 | sample_id),
                family = NO,
                data = df.ov_params)

t1.p12 <- chooseDist(m1.p12, type="realAll", parallel = "snow", ncpus = 4)

# Lowest crit., parsimony <-> fit
getOrder(t1.p12, 3)

## PE2 (skew exponential power type 1)

# Then update the model and compare, based on AIC/BIC, how much we improved
m2.PE2.p12 <- update(m1.p12, family=names(getOrder(t1.p12, 3)[1]))

summary(m1.p12)
summary(m2.PE2.p12)

AIC(m1.p12, m2.PE2.p12)
BIC(m1.p12, m2.PE2.p12)

plot(m2.PE2.p12) ## deviates at the center
plot(m1.p12) ## deviates at the tails

## P50 ---- 
m1.p50 = gamlss(p50_MPa ~ species * date * year + re(random=~1 | sample_id),
                family = NO, ## normal dist, not no distribution...
                data = df.ov_params)

t1.p50 <- chooseDist(m1.p50, type="realAll", parallel = "snow", ncpus = 4)

# Lowest crit., parsimony <-> fit
getOrder(t1.p50, 3)

## JSUo (Johnson)

# Then update the model and compare, based on AIC/BIC, how much we improved
m2.JSUo.p50 <- update(m1.p50, family=names(getOrder(t1.p50, 3)[1]))

summary(m1.p50)
summary(m2.JSUo.p50)

AIC(m1.p50, m2.JSUo.p50)
BIC(m1.p50, m2.JSUo.p50)

plot(m2.JSUo.p50) ## tri-modal humps?
plot(m1.p50) ## fits much better ot the QQ plot

## P88 ---- 
m1.p88 = gamlss(p88_MPa ~ species * date * year + re(random=~1 | sample_id),
                family = NO,
                data = df.ov_params)

t1.p88 <- chooseDist(m1.p88, type="realAll", parallel = "snow", ncpus = 4)
## SHASH (sin arcsin)

# Lowest crit., parsimony <-> fit
getOrder(t1.p88, 3)

# Then update the model and compare, based on AIC/BIC, how much we improved
m2.SHASH.p88 <- update(m1.p88, family=names(getOrder(t1.p88, 3)[1]))

summary(m1.p88)
summary(m2.SHASH.p88)

AIC(m1.p88, m2.SHASH.p88)
BIC(m1.p88, m2.SHASH.p88)

plot(m2.SHASH.p88) ## tri-modal humps?
plot(m1.p88) ## fits much better ot the QQ plot, deviation at tails

# final models ----

## P12 ----

lme.p12 = lme4::lmer(
  p12_MPa ~ species * year * date + (1 | sample_id),
  # random = ~ 1 | sample_id,
  data = df.ov_params)

 
# lm(
#   p12_MPa ~ species + year + doy,
#   data = df.ov_params
# )

summary(lme.p12)

unique_doy = unique(df.ov_params$doy)

emm.p12.lme = emmeans::emmeans(
  lme.p12,
  ~ species * year * date,
  # at = list(doy = unique_doy),
  adjust = "mvt",
  type = "response",
  # method = "pairwise",
  # cov.keep = "doy"
) %>% as.data.frame()

emm.p12.lme %>% 
  ggplot() +
    geom_pointrange(aes(x = date %>% as.Date(), y = emmean, ymin = lower.CL , ymax = upper.CL, col = species)) 

prior.p12.normal = default_prior(
  p12_MPa ~ species * year * date + (1 | sample_id),
  family = gaussian(),
  data = df.ov_params)

m3.p12.normal = brm(
  p12_MPa ~ species * year * date + (1 | sample_id),
  family = gaussian(),
  data = df.ov_params,
  prior = prior.p12.normal,
  chains = 8,
  cores = 6,
  iter = 5000,
  warmup = 2000,
  thin = 5,
  seed = 2300,
  # seed for reproducibility
  control = list(adapt_delta = 0.95, max_treedepth = 10),
  save_model = "m3.p12.normal",
  save_pars = save_pars(all = TRUE)
)
## Warning message: Parts of the model have not converged

## fit quality checks

summary(m3.p12.normal)
coef(m3.p12.normal) 

# Get the coef of the model. The interpretation is the same as the lmer version. 
# But now we have CREDIBLE intervals instead of CONFIDENCE intervals. 
# If the CI contain 0 then the corresponding parameters is statistically not different from 0, 
# else at the 95% level they are not 0.

## Simple plot of the posterior samples of the coefficients and the trace plots (caterplliar looking plots)
plot(m3.p12.normal)
mcmc_plot(m3.p12.normal, variable = "^b_", regex = T)
mcmc_plot(m3.p12.normal, variable = "^b_", regex = T, type = "acf")

## We want the 2 curves be close to each other
pp_check(m3.p12.normal, ndraws = 200, type = "loo_ribbon")
pp_check(m3.p12.normal, ndraws = 200, type = "scatter_avg")

## We also compute the posterior distribution of the response and compare it the observed one. 
## We want them to be very similar. In our case there is a little bimodality and skewness 
## that is not capture in the posterior density. Some improvement in the model could help
pp_check(m3.p12.normal, ndraws = 100) 

# loo_fit.normal <- loo(m3.p12.normal, save_psis = T) # We need the psis for later

## not used as only normal is fitted
# loo_compare(loo_fit.normal, loo_fit.pe2) # normal has lower elpd diff
# loo_compare(WAIC(m3.p12.normal), WAIC(m3.p12.pe2))
# bayes_factor(m3.p12.normal, m3.p12.pe2, log=T) # normal model 1 fits better

write_rds(m3.p12.normal, "bayesian_models/m3_p12_normal.rds")

## P50 ----

prior.p50.normal = default_prior(p50_MPa ~ species * date * year + (1 | sample_id),
                                 family = gaussian(),
                                 data = df.ov_params)

# prior.p50.jsuo = default_prior(p50_MPa ~ species * date * year + (1 | sample_id),
#                               family = , 
#                               data = df.ov_params)

m3.p50.normal = brm(
  p50_MPa ~ species * date * year + (1 | sample_id),
  family = gaussian(),
  data = df.ov_params,
  prior = prior.p50.normal,
  chains = 8,
  cores = 16,
  iter = 5000,
  warmup = 2000,
  thin = 5,
  seed = 2300,
  # seed for reproducibility
  control = list(adapt_delta = 0.95, max_treedepth = 10),
  save_model = "m3.p50.normal",
  save_pars = save_pars(all = TRUE)
)
## Warning message: Parts of the model have not converged

## fit quality checks

summary(m3.p50.normal)
coef(m3.p50.normal) 

plot(m3.p50.normal)
mcmc_plot(m3.p50.normal, variable = "^b_", regex = T)
mcmc_plot(m3.p50.normal, variable = "^b_", regex = T, type = "acf")

pp_check(m3.p50.normal, ndraws = 200, type = "loo_ribbon")

pp_check(m3.p50.normal, ndraws = 200, type = "scatter_avg")

pp_check(m3.p50.normal, ndraws = 100) 
## also bimodal like p12

write_rds(m3.p50.normal, "bayesian_models/m3_p50_normal.rds")

## P88 ----

prior.p88.normal = default_prior(p88_MPa ~ species * date * year + (1 | sample_id),
                                 family = gaussian(),
                                 data = df.ov_params)

# prior.p88.jsuo = default_prior(p88_MPa ~ species * date * year + (1 | sample_id),
#                               family = , 
#                               data = df.ov_params)

m3.p88.normal = brm(
  p88_MPa ~ species * date * year + (1 | sample_id),
  family = gaussian(),
  data = df.ov_params,
  prior = prior.p88.normal,
  chains = 8,
  cores = 16,
  iter = 5000,
  warmup = 2000,
  thin = 5,
  seed = 2300,
  # seed for reproducibility
  control = list(adapt_delta = 0.95, max_treedepth = 10),
  save_model = "m3.p88.normal",
  save_pars = save_pars(all = TRUE)
)
## Warning message: Parts of the model have not converged

## fit quality checks

summary(m3.p88.normal)
coef(m3.p88.normal) 

plot(m3.p88.normal)
mcmc_plot(m3.p88.normal, variable = "^b_", regex = T)
mcmc_plot(m3.p88.normal, variable = "^b_", regex = T, type = "acf")

pp_check(m3.p88.normal, ndraws = 200, type = "loo_ribbon")

pp_check(m3.p88.normal, ndraws = 200, type = "scatter_avg")

pp_check(m3.p88.normal, ndraws = 100) 

write_rds(m3.p88.normal, "bayesian_models/m3_p88_normal.rds")



# load saved models -------------------------------------------------------

m3.p12.normal = read_rds("bayesian_models/m3_p12_normal.rds")
m3.p50.normal = read_rds("bayesian_models/m3_p50_normal.rds")
m3.p88.normal = read_rds("bayesian_models/m3_p88_normal.rds")


# extract coefficients ----------------------------------------------------

p12.draws = m3.p12.normal %>% 
  tidybayes::summarise_draws(
    "mean",
    ~ quantile(.x, probs = c(.05, .25, .5, .75, .95))
  )

p12.draws

m3.p12.normal |> bayes_R2()
m3.p12.normal |> loo_R2()

p50.draws = m3.p50.normal %>% 
  tidybayes::summarise_draws(
    "mean",
    ~ quantile(.x, probs = c(.05, .25, .5, .75, .95))
  )

p50.draws

m3.p50.normal |> bayes_R2()
m3.p50.normal |> loo_R2()

p88.draws = m3.p88.normal %>% 
  tidybayes::summarise_draws(
    "mean",
    ~ quantile(.x, probs = c(.05, .25, .5, .75, .95))
  )

p88.draws

m3.p88.normal |> bayes_R2()
m3.p88.normal |> loo_R2()

# extract random effect posterior distributions ----

plot.mcmc_p12 <- mcmc_areas(m3.p12.normal, prob = 0.95, pars = vars(starts_with("b_")))
plot.mcmc_p12 +
  geom_vline(xintercept = 0) +
  labs(
    title = "Posterior distribution",
    subtitle = "of coef with 95% credible intervals"
  )
fixef(m3.p12.normal)
ranef(m3.p12.normal)
coef(m3.p12.normal) # fixed efffects + random effects

# emmeans -----------------------------------------------------------------

## p12 ----

# emm.p12 <- emmeans::emmeans(
#   lme_psi_ft,
#   ~ species * campaign * year,
#   adjust = "mvt",
# )

# df_emm_psi_ft <- emm_psi_ft |>
#   multcomp::cld(Letters = letters) |>
#   as.data.frame()

emm.p12_blme <- emmeans::emmeans(
  m3.p12.normal,
  ~ species * year * date,
  epred = T,
  adjust = "mvt"
)

df.emm.p12_blme <- emm.p12_blme |>
  multcomp::cld(Letters = letters) |>
  as.data.frame() 

df.emm.p12_blme = df.emm.p12_blme %>%
  # mutate(date = as.Date(date)) %>% 
  left_join(df.ov_params %>%
              select(species, date, year, p12_MPa)%>%
              mutate(date = as.factor(date)),
            by = c("date", "species", "year")) %>% 
  mutate(date_plot = as.Date(date),
         group_y = case_when(species == "FASY" ~ 0, species == "FREX" ~ -6),
  )
year(df.emm.p12_blme$date_plot) = 2000

## p50 ----

emm.p50_blme <- emmeans::emmeans(
  m3.p50.normal,
  ~ species * year * date,
  epred = T,
  adjust = "mvt"
)

df.emm.p50_blme <- emm.p50_blme |>
  multcomp::cld(Letters = letters) |>
  as.data.frame() 

df.emm.p50_blme = df.emm.p50_blme %>%
  # mutate(date = as.Date(date)) %>% 
  left_join(df.ov_params %>%
              select(species, date, year, p50_MPa)%>%
              mutate(date = as.factor(date)),
            by = c("date", "species", "year")) %>% 
  mutate(date_plot = as.Date(date),
         group_y = case_when(species == "FASY" ~ 0, species == "FREX" ~ -6.5),
  )
year(df.emm.p50_blme$date_plot) = 2000

## p88 ----

emm.p88_blme <- emmeans::emmeans(
  m3.p88.normal,
  ~ species * year * date,
  epred = T,
  adjust = "mvt"
)

df.emm.p88_blme <- emm.p88_blme |>
  multcomp::cld(Letters = letters) |>
  as.data.frame() 

df.emm.p88_blme = df.emm.p88_blme %>%
  # mutate(date = as.Date(date)) %>% 
  left_join(df.ov_params %>%
              select(species, date, year, p88_MPa)%>%
              mutate(date = as.factor(date)),
            by = c("date", "species", "year")) %>% 
  mutate(date_plot = as.Date(date),
         group_y = case_when(species == "FASY" ~ 0, species == "FREX" ~ -10),
  )
year(df.emm.p88_blme$date_plot) = 2000

# plot models ---- 

## p12 ----
dodge_width = 5

plot.p12.png <- df.emm.p12_blme |>
  arrange(species, date, year) |>
  # mutate(species = recode(species, "FASY" = "Fagus sylvatica", "FREX" = "Fraxinus excelsior"),
  #        group = f.reletter_cld(.group)) |>
  ggplot() +
  geom_point(
    aes(x = date_plot, y = p12_MPa, col = species),
    alpha = 0.8,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_line(
    aes(x = date_plot, y = emmean, col = species),
    alpha = 0.2,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_errorbar(
    aes(x = date_plot, ymin = asymp.LCL, ymax = asymp.UCL, color = species),
    width = 3, # replace lower.CL/upper.CL with asymp.LCL/asymp.UCL
    position = position_dodge(width = dodge_width),
    alpha = 0.2,
    show.legend = F
  ) +
  geom_text(
    aes(x = date_plot, y = group_y, label = .group, col = species),
    show.legend = F
  ) +
  see::scale_color_oi(order = c(6, 2)) +
  scale_x_date(limits = c(as.Date("2000-05-15"), as.Date("2000-09-30"))) +
  lims(y = c(-6, 0)) +
  labs(y = expression(Psi[12] ~ "[MPa]"), x = "Date") +
  guides(color = guide_legend(title = "Species")) +
  facet_wrap(~year) +
  theme_bw() +
  #thesis_theme +
  theme(strip.background = element_blank())
plot.p12.png 

ggsave(plot.p12.png, filename = "figures/blme/plot.p12.png", width = 12, height = 8, units = "cm")

## p50 ----

plot.p50.png <- df.emm.p50_blme |>
  arrange(species, date, year) |>
  # mutate(species = recode(species, "FASY" = "Fagus sylvatica", "FREX" = "Fraxinus excelsior"),
  #        group = f.reletter_cld(.group)) |>
  ggplot() +
  geom_point(
    aes(x = date_plot, y = p50_MPa, col = species),
    alpha = 0.8,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_line(
    aes(x = date_plot, y = emmean, col = species),
    alpha = 0.2,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_errorbar(
    aes(x = date_plot, ymin = asymp.LCL, ymax = asymp.UCL, color = species),
    width = 3, # replace lower.CL/upper.CL with asymp.LCL/asymp.UCL
    position = position_dodge(width = dodge_width),
    alpha = 0.2,
    show.legend = F
  ) +
  geom_text(
    aes(x = date_plot, y = group_y, label = .group, col = species),
    show.legend = F
  ) +
  see::scale_color_oi(order = c(6, 2)) +
  scale_x_date(limits = c(as.Date("2000-05-15"), as.Date("2000-09-30"))) +
  lims(y = c(-6.5, 0)) +
  labs(y = expression(Psi[50] ~ "[MPa]"), x = "Date") +
  guides(color = guide_legend(title = "Species")) +
  facet_wrap(~year) +
  theme_bw() +
  #thesis_theme +
  theme(strip.background = element_blank())
plot.p50.png 

ggsave(plot.p50.png, filename = "figures/blme/plot.p50.png", width = 12, height = 8, units = "cm")

## p88 ----

plot.p88.png <- df.emm.p88_blme |>
  arrange(species, date, year) |>
  # mutate(species = recode(species, "FASY" = "Fagus sylvatica", "FREX" = "Fraxinus excelsior"),
  #        group = f.reletter_cld(.group)) |>
  ggplot() +
  geom_point(
    aes(x = date_plot, y = p88_MPa, col = species),
    alpha = 0.8,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_line(
    aes(x = date_plot, y = emmean, col = species),
    alpha = 0.2,
    position = position_dodge(width = dodge_width),
    show.legend = F
  ) +
  geom_errorbar(
    aes(x = date_plot, ymin = asymp.LCL, ymax = asymp.UCL, color = species),
    width = 3, # replace lower.CL/upper.CL with asymp.LCL/asymp.UCL
    position = position_dodge(width = dodge_width),
    alpha = 0.2,
    show.legend = F
  ) +
  geom_text(
    aes(x = date_plot, y = group_y, label = .group, col = species),
    show.legend = F
  ) +
  see::scale_color_oi(order = c(6, 2)) +
  scale_x_date(limits = c(as.Date("2000-05-15"), as.Date("2000-09-30"))) +
  lims(y = c(-10, 0)) +
  labs(y = expression(Psi[88] ~ "[MPa]"), x = "Date") +
  guides(color = guide_legend(title = "Species")) +
  facet_wrap(~year) +
  theme_bw() +
  #thesis_theme +
  theme(strip.background = element_blank())
plot.p88.png 

ggsave(plot.p88.png, filename = "figures/blme/plot.p88.png", width = 12, height = 8, units = "cm")

# test models to account for bimodality ----
m3.p12.pe2 = brm(
  p12_MPa ~ species * date * year + (1 | sample_id),
  family = exponential(link = "log"),
  data = df.ov_params,
  prior = prior.p12.pe2,
  chains = 8,
  cores = 6,
  iter = 5000,
  warmup = 2000,
  thin = 5,
  seed = 2300,
  # seed for reproducibility
  control = list(adapt_delta = 0.95, max_treedepth = 10),
  save_model = "m3.p12.pe2",
  save_pars = save_pars(all = TRUE)
)
## Warning messages: Parts of the model have not converged (some Rhats are > 1.05). 

## Mixture model
## aka two distributions (2 gaussian) to counter bimodality
df.ov_params %>% 
  ggplot() +
    geom_density(aes(x = p12_MPa, col = species))

## https://discourse.mc-stan.org/t/specifying-a-mixture-model/9724
## https://paulbuerkner.com/brms/reference/mixture.html

set.seed(1234)

mix.p12 = mixture(gaussian, gaussian)

prior.p12.mixed = c(
  prior(normal(-3.5, 2), Intercept, dpar = "mu1"),
  prior(normal(-2, 2), Intercept, dpar = "mu2")
)

bf.p12 = bf(p12_MPa ~ 1,
            mu1 ~ year * date, mu2 ~ species + (1 | sample_id))

bf.p12 = bf(p12_MPa ~ 1,
            mu1 ~ year, mu2 ~ species)

m3.p12.mixed = brm(bf.p12,
                   family = mix.p12,
                   data = df.ov_params,
                   prior = prior.p12.mixed,
                   chains = 8,
                   cores = 6,
                   iter = 5000,
                   warmup = 2000,
                   thin=5,
                   seed= 2300, # seed for reproducibility
                   control = list(adapt_delta = 0.95, max_treedepth = 10),
                   save_model = "m3.p12.mixed",
                   save_pars = save_pars(all = TRUE))



# Model evaluation
summary(m3.p12.mixed)
coef(m3.p12.mixed) 
# Get the coef of the model. The interpretation is the same as the lmer version. 
# But now we have CREDIBLE intervals instead of CONFIDENCE intervals. 
# If the CI contain 0 then the corresponding parameters is statistically not different from 0, 
# else at the 95% level they are not 0.

## Simple plot of the posterior samples of the coefficients and the trace plots (caterplliar looking plots)
plot(m3.p12.mixed)
mcmc_plot(m3.p12.mixed, variable = "^b_", regex = T)
mcmc_plot(m3.p12.mixed, variable = "^b_", regex = T, type = "acf")

## We want the 2 curves be close to each other
pp_check(m3.p12.normal, ndraws = 200, type = "loo_ribbon")
pp_check(m3.p12.pe2, ndraws = 200, type = "loo_ribbon")
pp_check(m3.p12.mixed, ndraws = 200, type = "loo_ribbon")

pp_check(m3.p12.pe2, ndraws = 200, type = "scatter_avg")
pp_check(m3.p12.pe2, ndraws = 200, type = "scatter_avg")
pp_check(m3.p12.mixed, ndraws = 200, type = "scatter_avg")

## We also compute the posterior distribution of the response and compare it the observed one. 
## We want them to be very similar. In our case there is a little bimodality and skewness 
## that is not capture in the posterior density. Some improvement in the model could help
pp_check(m3.p12.mixed, ndraws = 100) 

loo_fit.normal <- loo(m3.p12.normal, save_psis = T) # We need the psis for later
loo_fit.pe2 <- loo(m3.p12.pe2, save_psis = T) # We need the psis for later
loo_fit.mixed <- loo(m3.p12.mixed, save_psis = T) # We need the psis for later

loo_compare(loo_fit.normal, loo_fit.pe2) # normal has lower elpd diff
loo_compare(WAIC(m3.p12.normal), WAIC(m3.p12.pe2))
bayes_factor(m3.p12.normal, m3.p12.pe2, log=T) # normal model 1 fits better
